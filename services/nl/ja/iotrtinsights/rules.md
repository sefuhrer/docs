---

copyright:
  years: 2015,2016

---

{:shortdesc: .shortdesc}

# ルールの作成およびアラートへの対応{: #rules}

分析ルールを使用して、デバイスのアラートおよび通知をセットアップします。例えば、デバイスの温度センサーが異常に高い温度を記録した場合にアラートをデバイス・ダッシュボードに追加し、E メールを管理者に送信するルールを作成できます。
{: shortdesc}

データ・ポイントまたはコンテキスト・パラメーター (資産マッピングなど) を静的な値、他のデータ・ポイント、またはコンテキスト・パラメーターと比較する条件が含まれたルールを使用できます。

>**注:** {{site.data.keyword.iotrtinsights_short}} の無料プラン・インスタンスを使用している場合、1 時間後にすべてのルールが自動的に非アクティブ化されます。ルールを手動で再アクティブ化できます。継続的にルールを適用するために、有料プランにアップグレードできます。

デバイスのルールを作成するには、以下のようにします。
1. {{site.data.keyword.iotrtinsights_short}}  コンソールで、**「分析 (Analytics)」>「ルール」**に移動します。
2. **「新規ルールの追加 (Add new rule)」**をクリックし、ルールに名前を付け、説明を指定し、ルールのメッセージ・スキーマを選択してから、**「次へ」**をクリックします。  
3. **「OK」**をクリックして新規ルールを作成します。
3. **オプション:** ルールのアラート優先順位を選択します。
優先順位を使用して、アラート・パネルで表示されるアラートを分類します。デフォルトの優先順位は「低 (Low)」です。
3. ルール・ロジックをセットアップするには、ルールのトリガーとして使用される 1 つ以上の IF 条件を追加します。条件を並列行に追加して、OR 条件として適用できます。あるいは、条件を連続列に追加して、AND 条件として適用できます。
**ヒント:** デバイスで返される標準的な値がどのようなものか把握するには、**「デバイス」>「デバイスの参照 (Browse devices)」**に移動し、デバイスをクリックして、表示されるリアルタイム・データを確認してください。
**重要:** 2 つのデータ・ポイントを比較する条件をトリガーする場合、または順次的に結合された 2 つ以上のデータ・ポイント条件をトリガーする場合、トリガー・データは、同じメッセージに含まれている必要があります。データが複数のメッセージで受信された場合、そのような条件または順次条件はトリガーされません。  
> **例:**   
シンプルなルールにより、パラメーター値が指定値よりも大きい場合にアラートをトリガーできます。  
例: 条件 = `ax>5`  
より複雑なルールにより、特定の資産にマップされているデバイスが特定の値を超過した場合にアラートをトリガーできます。  
例: 条件 = `ax>5 AND asset.assetnum==5001`   
詳細なステップについては、『[例: メッセージ・スキーマおよびコンテキスト・パラメーター条件を使用した複雑なルールの作成](#complex "例: メッセージ・スキーマおよびコンテキスト・パラメーター条件を使用した複雑なルールの作成")』を参照してください。  
4. ルールの条件付きトリガー要件を構成します。
特定の期間にルールに対してトリガーされるアラートの数を制御するために、ルールの条件付きトリガー要件を構成できます。
**重要:** 条件付きトリガーは、ルール内のすべての条件に対して機能します。例えば、ルールで 5 つの異なる並列 (OR) 条件が設定されている場合、true である各条件が、条件付きトリガーのカウントにカウントされます。
ルールの条件付きトリガーを設定するには、以下のようにします。
 1. ルール・エディターで、リンク**「条件が満たされるたびにトリガーする (Trigger each time conditions are met)」**をクリックして、条件ダイアログを開きます。
 2. ルールで使用する条件付きトリガーを選択して構成します。
 <ul>
 <li>条件が満たされるたびにトリガーする (Trigger each time conditions are met)</li>
 <li>M *時間単位* で N 回条件が満たされた場合にトリガーする (Trigger if conditions are met N times in M *Unit of time*)</li>
 </ul>  
 条件付きトリガーの詳細な説明については、『[条件付きトリガー](#conditional "条件付きトリガーの概要")』を参照してください。
5. ルール条件が満たされた場合に行われる 1 つ以上のアクションを作成または選択します。
アクションについて詳しくは、『[アクションの作成](actions.html#shared "アクションの作成")』を参照してください。   
 > 例: アクションを E メールの送信にすることができます。各種アクション・タイプについては、『[アクション・タイプ](actions.html "アクション・タイプ")』を参照してください。
6. ルールが完成したら、**「保存」**をクリックします。
7. 「ルール」ページで、![「構成」アイコン](images/gear.png "「構成」アイコン")をクリックし、**「アクティブ化 (Activate)」**を選択してルールをアクティブ化します。

ルールはアクティブになっています。ルールの条件が満たされると、アラートが**「ダッシュボード (Dashboards)」>「概要」**ダッシュボードに追加され、ルール・アクションが実行されます。

## 条件付きトリガー {: #conditional}

特定の期間にルールに対してトリガーされるアラートの数を制御するために、ルールの条件付きトリガー要件を構成できます。

メッセージの頻度およびルール条件によっては、トリガー条件がいったん満たされると、ルールが何度もトリガーされてしまうことがあります。例えば、条件が `temp >= 90` で、温度が上昇して 91 度で安定化した場合、その後、メッセージが着信するごとにルールがトリガーされます。デバイス・メッセージの頻度、およびルールで実行するように設定されているアクションによっては、これにより、例えば E メール・ボックスが満杯になったり、最初のメッセージの後に追加値を提供しないメッセージの Twitter のフィードがあふれたりすることがあります。

**重要:** 条件付きトリガーは、ルール内のすべての条件に対して機能します。例えば、ルールで 5 つの異なる並列 (OR) 条件が設定されている場合、true である各条件が、条件付きトリガーのカウントにカウントされます。

条件 | 説明
------------- | -------------
条件が満たされるたびにトリガーする (Trigger each time conditions are met) | ルールは、ルール条件が満たされるたびにトリガーされます。
M *日/時間/分/カスタム* で N 回条件が満たされた場合にトリガーする (Trigger if conditions are met N times in M *days/hours/minutes/custom*) | ルールは、選択した時間間隔に N 回条件が満たされた場合にトリガーされ、その後は構成されている期間が経過するまで再度トリガーされません。</br>例: 条件付きトリガー要件 = `条件が 30 分に 4 回満たされた場合に 1 回のみトリガーする`。デバイスは、5 分ごとに 1 つの新規メッセージを送信します。正午に、温度が初めて 90 度を超え、条件が満たされたものとします。条件付きトリガーのカウンターが開始されますが、ルールはまだトリガーされません。15 分後、`temp > 90` であることを示すメッセージをさらに 3 つ受信し、ルールがトリガーされたものとします。この場合、温度に関係なく、その後 15 分間、ルールはトリガーされません。

## 例: メッセージ・スキーマおよびコンテキスト・パラメーター条件を使用した複雑なルールの作成 {: #complex}
資産番号 5001 にマップされる IoT 電話デバイスで ax パラメーターが値 5 を超過した場合にアラート・ダッシュボードでアラートを作成する複雑なルールを作成するには、以下のステップを実行します。
1. **「デバイス」>「資産マッピングの管理 (Manage Asset Mappings)」**に移動し、少なくとも 1 つの IoT 電話デバイスを、資産番号 5001 の資産にマップします。
詳細なステップについては、『[資産の管理](assets.html "資産の管理")』を参照してください。
2. **「分析 (Analytics)」**に移動し、**「新規ルールの追加 (Add new rule)」**をクリックします。
3. ルールに記述名を付け、説明を指定し、IoT 電話デバイス・タイプに対して作成したメッセージ・スキーマを選択することで、ルールが適用されるデバイス・タイプを指定します。
4. **「OK」**をクリックして新規ルールを作成します。
<!-- 5. Click ![Add icon.](images/rules_plus.png "Add icon") to add an initial condition. -->
6. 新しい条件のタイルをクリックし、初期条件を編集します。
 1. 比較するオペランドとして**「データ・ポイント (Data point)」**を選択します。
 2. **「ax」**データ・ポイントを選択します。
 3. **>** 演算子を選択し、第 1 オペランドの値が第 2 オペランドの値より大きくなった場合に条件が true になるようにします。
 3. 比較対象のオペランドとして**「静的値 (Static value)」**を選択します。
 4. 「ax」データ・ポイントの比較対象の値として `5` と入力します。
 5.  **「OK」**をクリックして条件を追加します。
5. AND 条件を追加するために、最初の条件の右にある![「追加」アイコン](images/rules_plus.png "「追加」アイコン") をクリックします。
6. 新しい条件のタイルをクリックし、条件を編集します。
  1. 比較するオペランドとして**「コンテキスト (context)」**を選択します。
  2. コンテキスト・パラメーター・メニューで、**「資産 (assets)」**コンテキスト・スキーマの前にある三角形をクリックして、資産コンテキスト・パラメーターのリストを展開します。
  3. **「ASSETNUM」**コンテキスト・スキーマ・パラメーターを選択します。
  3. **==** 演算子を選択し、第 1 オペランドと第 2 オペランドの値が等しい場合に条件が true になるようにします。
  3. 比較対象のオペランドとして**「静的値 (Static value)」**を選択します。
  4. **「ASSETNUM」**コンテキスト・スキーマ・パラメーターの比較対象の値として `5001` と入力します。
  5.  **「OK」**をクリックして条件を作成します。
7. デフォルトの`「条件が満たされるたびにトリガーする (Trigger each time conditions are met)」`条件付きトリガーを使用します。
7. 1 つ以上のアクションを作成または選択します。
7. 新しいルールを保存します。
7. 「ルール」ページの新しいルールのタイルで、![「構成」アイコン](images/gear.png "「構成」アイコン")をクリックし、**「アクティブ化 (Activate)」**を選択してルールをアクティブ化します。

## 例: 資産ベースのルールの作成{: #asset_rules}

デバイスが資産に正常にマップされた後に、資産の詳細を使用するルールを作成できます。デバイスを資産にマップし、データ・ポイントと資産情報の両方を取り込んだルールを作成するのは、強力なツールです。

以下の例では、資産を使用して企業の携帯電話を追跡します。2 つの資産が作成され、携帯電話にマップされています。資産 5001 は、PURCHASEPRICE < 100 の電話にマップされており、資産 5002 は PURCHASEPRICE >=100 の電話にマップされています。各例のデバイス・データ・トリガー条件は、`d.ax>5` であり、この単純化された例では、電話で急に加速度が増した動作 (例えば、落下した場合) に対応しています。

ここで、資産 5001 にマップされている電話が落下したことを知らせる 2 つのシンプルなルールをセットアップできます。5001 にマップされない電話が落下したことを追跡するルールをセットアップするのも同等に簡単です。これは、5002 のすべての電話、またはどの資産にもマップされていないすべての電話である場合が考えられます。

例 | ルール
------------- | -------------
デバイスが資産 5001 に属している場合にのみルールをトリガーする | IF `d.ax>5` AND  `asset.assetnum==5001` THEN ...
デバイスが資産 5001 に属していない場合にのみルールをトリガーする | IF `d.ax>5` AND  `asset.assetnum!=5001` THEN ...

特定の PURCHASEPRICE の電話の場合にトリガーされるルールをセットアップすることもできます。  

例 | ルール
------------- | -------------
電話の価格が 100 未満の場合にのみルールをトリガーする | IF `d.ax>5` AND  `asset.purchaseprice<100` THEN ...
電話の価格が 100 以上の場合にのみルールをトリガーする | IF `d.ax>5` AND  `asset.purchaseprice>=100` THEN ...

最後に、これらのルールを組み合わせて、より複雑な動作を実現できます。

例 | ルール
------------- | -------------
電話が資産 5001 (価格が 100 未満) に属しているが、価格が 75 を超えている場合にのみルールをトリガーする | IF `d.ax>5` AND `asset.assetnum==5001` AND  `asset.purchaseprice>75` THEN ...
電話が資産 5002 (価格が 100 以上) に属しているが、価格が 200 未満の場合にのみルールをトリガーする | IF `d.ax>5`  AND `asset.assetnum==5002` AND  `asset.purchaseprice<200` THEN ...
